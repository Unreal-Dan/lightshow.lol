name: Deploy PR Preview to GitHub Pages

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-pr-preview
  cancel-in-progress: true

env:
  EMSDK_VERSION: "4.0.9"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Vortex Engine
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: StoneOrbits/VortexEngine
          path: VortexEngine
          ref: desktop

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 nodejs cmake make git

      - name: Build Vortex CLI Tool
        run: |
          cd VortexEngine/VortexEngine/VortexCLI
          make -j

      - name: Install Emscripten (pinned)
        shell: bash
        run: |
          set -euo pipefail
          git clone https://github.com/emscripten-core/emsdk.git
          cd emsdk
          git fetch --tags
          git checkout "${EMSDK_VERSION}"
          ./emsdk install "${EMSDK_VERSION}"
          ./emsdk activate "${EMSDK_VERSION}"

      - name: Build WebAssembly with Emscripten
        shell: bash
        run: |
          set -euo pipefail
          source emsdk/emsdk_env.sh
          cd VortexEngine/VortexEngine/VortexLib
          make clean
          make -j wasm

      - name: Checkout lightshow.lol (current repo)
        uses: actions/checkout@v4
        with:
          path: lightshow.lol
          fetch-depth: 0

      - name: Generate js/version.js from tags
        shell: bash
        run: |
          set -euo pipefail
          cd lightshow.lol

          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          if [[ ! "$TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid TAG format: $TAG. Using default 0.0.0"
            TAG="0.0.0"
          fi

          COUNT=$(git rev-list "${TAG}"..HEAD --count 2>/dev/null || echo "0")

          IFS='.' read -r MAJOR MINOR PATCH <<< "$TAG"
          MAJOR=$((MAJOR + 0))
          MINOR=$((MINOR + 0))
          PATCH=$((PATCH + 0))
          COUNT=$((COUNT + 0))

          NEW_PATCH=$((PATCH + COUNT))
          VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

          mkdir -p js
          echo "export const VERSION = '${VERSION}';" > js/version.js
          echo "Generated Version: ${VERSION}"

      - name: Copy VortexLib artifacts into site
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p lightshow.lol/js
          cp VortexEngine/VortexEngine/VortexLib/VortexLib.js   lightshow.lol/js/VortexLib.js
          cp VortexEngine/VortexEngine/VortexLib/VortexLib.wasm lightshow.lol/js/VortexLib.wasm

      - name: Build CSS + add cache busters
        shell: bash
        run: |
          set -euo pipefail
          cd lightshow.lol
          chmod +x ./build_css.sh
          ./build_css.sh
          chmod +x ./add_cache_busters.sh
          ./add_cache_busters.sh

      - name: Upload site artifact to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: lightshow.lol

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

